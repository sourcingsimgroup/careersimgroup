<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CAREER SIMGROUP • Mini Job Portal</title>
  <meta name="description" content="CAREER SIMGROUP. Mini job portal dengan filter Branch → Area → Group Job (dependent), search + autosuggest, kartu job, popup detail + Apply. Fokus: load data robust, cepat (cache + pager), fallback andal."/>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#1BAFBF;
      --ink:#0f172a;
      --muted:#f8fafc;
      --line: rgba(148,163,184,.55);
      --card:#ffffff;
      --radius:18px;
      --sticky-top:0px;
      --sel-w:210px;

      --indigo:#4f46e5;
      --blueDeep:#0f2a5f;
    }

    /* ========== SHARP MODE GLOBAL (NO BLUR) ========== */
    *{
      box-sizing:border-box;
      -webkit-backdrop-filter:none !important;
      backdrop-filter:none !important;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink);
      /* hanya gradasi sky -> putih (tanpa kabut/radial blur) */
      background: linear-gradient(180deg, #dbeafe 0%, #ffffff 70%, #ffffff 100%);
      background-attachment: fixed;
      background-repeat:no-repeat;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 80px}

    /* ===== Header (tanpa blur & tanpa shadow) ===== */
    header{
      position:sticky;top:0;z-index:30;
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .head-inner{
      max-width:1100px;margin:0 auto;padding:10px 16px;
      display:flex;align-items:center;gap:14px
    }
    .brand{display:flex;align-items:center;gap:10px;min-height:44px}
    .brand img{
      height:36px;width:auto;display:block;object-fit:contain;
      /* hilangkan drop-shadow (sering bikin blur-look) */
      filter:none !important;
    }
    .title h1{
      font-size:30px;line-height:1.1;margin:0;
      letter-spacing:.6px;font-weight:800;color:#0b7f91;
    }

    .hamburger{
      margin-left:auto;display:none;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:#fff;border-radius:999px;padding:8px 12px;
      font-weight:800;cursor:pointer;
    }
    .hamburger svg{width:18px;height:18px}

    /* ===== Filter Card (tanpa blur & shadow) ===== */
    .filters{
      position:sticky; top:calc(var(--sticky-top));
      z-index:25;
      margin:14px 0 10px;
      background:#fff;
      border:1px solid var(--line);
      padding:12px;border-radius:16px;
    }
    .filters .row{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
    }
    .fgrp{
      display:flex;align-items:center;gap:8px;
      background:#fff;border:1px solid var(--line);
      padding:8px 10px;border-radius:12px;
    }
    .fgrp label{font-size:12px;color:#334155;font-weight:800}
    .fgrp select{
      appearance:auto;border:none;outline:none;
      font-size:13px;padding:6px 8px;background:transparent;color:#0f172a;
      min-width:var(--sel-w);width:var(--sel-w);
    }
    .fgrp select:disabled{opacity:.55;cursor:not-allowed;background:#f8fafc}

    .f-actions{margin-left:auto;display:flex;gap:8px;align-items:center;}

    .btn{
      border:none;outline:none;border-radius:999px;padding:10px 14px;
      font-weight:800;letter-spacing:.2px;cursor:pointer;
    }
    .btn-primary{background:var(--brand);color:#00323a;border:1px solid rgba(13,92,102,.35)}
    .btn-ghost{background:#fff;color:#0f172a;border:1px solid var(--line)}

    #btn-clear, #mf-clear{
      background:#fff;border:1px solid rgba(99,102,241,.45);
      padding:8px 12px;
    }
    #btn-apply, #mf-apply{
      background:var(--brand); border:1px solid rgba(13,92,102,.35);
      color:#00323a; padding:8px 12px;
    }

    /* ===== Search (text tidak bold) ===== */
    .search{
      position:relative;
      display:flex;align-items:center;gap:8px;
      background:#fff;border:1px solid var(--line);
      padding:8px 10px;border-radius:12px;
      flex: 1 1 260px;
      min-width:240px;
    }
    .search .sico{
      width:28px;height:28px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background:#eef2ff;
      border:1px solid rgba(79,70,229,.25);
      color:#0f172a;
      flex:0 0 auto;
    }
    .search .sico svg{width:16px;height:16px}
    .search input{
      width:100%;
      border:none;outline:none;background:transparent;
      font: 500 13px/1.2 Montserrat, system-ui; /* <- tidak bold */
      color:#0f172a;
    }
    .search input::placeholder{color:#64748b;font-weight:500}

    /* ===== Suggest dropdown (muncul >=3 huruf) ===== */
    .sug{
      position:absolute; left:0; right:0;
      top:calc(100% + 8px);
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      z-index:99;
      max-height:320px;
      overflow:auto;
    }
    .sug .sug-hd{
      padding:10px 12px;
      border-bottom:1px solid rgba(148,163,184,.30);
      font: 800 11px/1 Arial, Helvetica, sans-serif;
      letter-spacing:.25px;
      color:#334155;
      background:#f8fafc;
    }
    .sug .sug-item{
      padding:10px 12px;
      display:flex; gap:10px; align-items:flex-start;
      cursor:pointer;
    }
    .sug .sug-item:hover{background:#f8fafc}
    .sug .sug-ico{
      width:30px;height:30px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background:#eef2ff;
      border:1px solid rgba(79,70,229,.25);
      color:#0f172a;
      flex:0 0 auto;
    }
    .sug .sug-ico svg{width:16px;height:16px}
    .sug .sug-title{
      font: 800 12px/1.2 Montserrat, system-ui;
      margin:0 0 4px;color:#0f172a;
    }
    .sug .sug-meta{
      font: 600 11px/1.2 Montserrat, system-ui;
      margin:0;color:#64748b;
    }

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;min-height:40vh}
    @media (max-width:960px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){
      .grid{grid-template-columns:1fr;gap:8px}
      .filters{display:none}
      .hamburger{display:inline-flex}
    }

    /* Card Job (semi formal, tajam tanpa blur overlay) */
    .card{
      position:relative;
      border:1px solid var(--line);
      background:#fff;
      border-radius:var(--radius);
      padding:14px 14px 52px;
      cursor:pointer;
      overflow:hidden;
      transition: transform .12s ease, border-color .12s ease;
    }
    .card::before{
      content:"";
      position:absolute;left:0;top:0;bottom:0;width:4px;
      background:linear-gradient(180deg, rgba(79,70,229,.9), rgba(14,165,233,.6));
    }
    .card:hover{transform:translateY(-2px);border-color:rgba(79,70,229,.45)}
    .card:focus{outline:2px solid rgba(79,70,229,.35); outline-offset:2px}

    .cap-status{
      position:absolute;top:10px;right:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:6px 8px;
      display:grid;justify-items:center;gap:2px;min-width:68px;
    }
    .cap-status .ico{line-height:0}
    .cap-status .ico svg{width:18px;height:18px}
    .cap-status .lbl{
      font-size:10px;font-weight:900;letter-spacing:.35px;
      text-transform:uppercase;white-space:nowrap;color:#0b4c57;
    }
    .cap-status.urgent .lbl{color:#b42318}
    .cap-status.hiring .lbl{color:#067647}
    .cap-status.urgent .ico svg{color:#ef4444}
    .cap-status.hiring .ico svg{color:#10b981}

    .job-title,.job-parent{display:flex;align-items:center;gap:8px}
    .job-title{margin:2px 0 4px;font-size:13px;font-weight:900;color:#0b2a32}
    .job-parent{font-size:11px;font-weight:700;color:#0b4c57;margin:2px 0 10px}

    .i{
      display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border-radius:10px;
      background:#eef2ff;
      border:1px solid rgba(79,70,229,.25);
      color:#0f172a;
      flex:0 0 auto;
    }
    .job-title .i svg{width:16px;height:16px}
    .job-parent .i svg{width:15px;height:15px}

    .loc,.sal{display:flex;align-items:center;gap:8px;font-size:12px;color:#0b3d44;}
    .sal{color:#075e62;margin-top:7px}
    .loc svg,.sal svg{width:16px;height:16px;flex:0 0 auto;opacity:1}

    .card-ft{position:absolute;right:12px;bottom:12px;display:flex;gap:8px}

    /* Tombol Detail: kotak kecil, border indigo, bg putih, font Arial hitam */
    .pill{
      border-radius:10px;
      padding:7px 10px;
      cursor:pointer;
      font:700 12px/1 Arial, Helvetica, sans-serif;
      background:#fff;
      border:1.5px solid var(--indigo);
      color:#000;
    }

    /* Pager: tanpa blur */
    .pager{
      display:flex;align-items:center;justify-content:center;gap:10px;margin-top:14px;
      position:sticky;bottom:0;
      background:#fff;
      padding:10px 0;z-index:10;
      border-top:1px solid rgba(148,163,184,.30);
    }
    .page-info{font:700 12px/1.4 Montserrat,system-ui;color:#0f172a}

    .status{padding:24px;text-align:center;color:#334155}

    /* Modal */
    dialog{
      width:min(700px, 94vw);
      border:none;border-radius:20px;padding:0;
      box-shadow:none; /* no blur-like shadow */
    }
    #dlg::backdrop{background: rgba(2,6,23,.22)}
    .modal{padding:18px 18px 16px;position:relative;background:#fff;border:1px solid var(--line);border-radius:20px}
    .modal .title h2{font-size:20px;color:#062e33;margin:0}
    .modal .sub{margin:6px 0 10px;font-size:13px;color:#0b4c57;font-weight:800}
    .modal .meta{display:flex;align-items:center;gap:8px;color:#083344;font-size:13px}
    .modal .meta svg{width:18px;height:18px}
    .modal .qual{
      margin-top:14px;font-size:14px;line-height:1.5;color:#0f172a;
      background:#f8fafc;
      padding:14px;border-radius:12px;border:1px solid rgba(148,163,184,.35);
      max-height:min(46vh,420px);overflow:auto
    }
    .modal .qual ul{margin:0; padding-left:18px}
    .modal .actions{margin-top:16px;display:flex;gap:10px;justify-content:flex-end}
    .x{position:absolute;top:8px;right:10px;border:none;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#0f172a}

    /* Apply button modal: border biru tua, bg putih, font merah (Arial) */
    .apply-btn{
      display:inline-flex;align-items:center;gap:6px;
      font-family: Arial, Helvetica, sans-serif !important;
      font-weight:700 !important;
      background:#ffffff !important;
      color:#ff0000 !important;
      border:2px solid var(--blueDeep) !important;
      text-decoration:none;
    }
    .apply-btn svg{color:#ff0000 !important}

    /* Mobile dialog filter */
    #dlg-filter::backdrop{background:rgba(2,6,23,.42)}
    #dlg-filter{
      width:min(520px,96vw);border:none;border-radius:16px;padding:0;overflow:hidden;
      box-shadow:none;
    }
    .mfilter-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:#fff}
    .mfilter-bd{padding:14px;background:#f8fafc}
    .mfilter-row{display:flex;flex-direction:column;gap:8px}
    .mfilter-row .fgrp{width:100%}
    .mfilter-ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--line);background:#fff}
  </style>
</head>

<body>
  <header>
    <div class="head-inner">
      <div class="brand">
        <img src="https://res.cloudinary.com/djo0ewqoz/image/upload/v1761018548/WhatsApp_Image_2025-10-20_at_15.19.19_bn0qbh.jpg" alt="CAREER SIMGROUP logo" width="200">
      </div>
      <div class="title">
        <h1>CAREER SIMGROUP</h1>
      </div>

      <button class="hamburger" id="btn-open-filter" type="button" aria-label="Buka Filter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        Filter
      </button>
    </div>
  </header>

  <div class="wrap">
    <section class="filters" aria-label="Filter Loker">
      <div class="row">
        <div class="fgrp">
          <label for="f-branch">Branch</label>
          <select id="f-branch" title="Pilih Branch (Kolom B)"></select>
        </div>
        <div class="fgrp">
          <label for="f-area">Area</label>
          <select id="f-area" title="Pilih Branch dulu" disabled></select>
        </div>
        <div class="fgrp">
          <label for="f-parent">Group Job</label>
          <select id="f-parent" title="Pilih Area dulu" disabled></select>
        </div>

        <div class="search" role="search" aria-label="Pencarian job">
          <div class="sico" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 4a6 6 0 1 0 0 12 6 6 0 0 0 0-12Zm-8 6a8 8 0 1 1 14.32 4.906l4.387 4.387-1.414 1.414-4.387-4.387A8 8 0 0 1 2 10Z"/>
            </svg>
          </div>
          <input id="q" type="search" placeholder="Cari job (nama / group job / area)..." autocomplete="off" />
          <div class="sug" id="sug" hidden></div>
        </div>

        <div class="f-actions">
          <button class="btn btn-ghost" id="btn-clear" type="button">Clear</button>
          <button class="btn btn-primary" id="btn-apply" type="button">Apply</button>
        </div>
      </div>
    </section>

    <div id="status" class="status" role="status" aria-live="polite" aria-busy="true">Mengambil data…</div>
    <section id="grid" class="grid" hidden></section>

    <div id="pager" class="pager" hidden>
      <button class="btn btn-ghost" id="pg-prev" type="button">◀︎ Before</button>
      <span class="page-info" id="pg-info">-</span>
      <button class="btn btn-primary" id="pg-next" type="button">Next ▶︎</button>
    </div>
  </div>

  <!-- Modal Detail -->
  <dialog id="dlg">
    <div class="modal">
      <button class="x" id="dlg-x" aria-label="Tutup">×</button>
      <div class="title"><h2 id="dlg-job">-</h2></div>
      <div class="sub" id="dlg-parent">-</div>

      <div class="meta">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/></svg>
        <span id="dlg-area">-</span>
      </div>

      <div class="meta sal-meta">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h18a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1Zm3 2v6m12-6v6"/><circle cx="12" cy="12" r="2.5"/></svg>
        <span id="dlg-salary">-</span>
      </div>

      <div class="qual" id="dlg-qual">-</div>

      <div class="actions">
        <a class="btn btn-primary apply-btn" id="dlg-apply" href="apply.html" target="_blank" rel="noopener noreferrer" title="Apply via CAREER SIMGROUP">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M5 12h9M12 5l7 7-7 7"/></svg>
          Apply
        </a>
        <button class="btn btn-ghost" id="dlg-close" type="button">Tutup</button>
      </div>
    </div>
  </dialog>

  <!-- Dialog Filter Mobile -->
  <dialog id="dlg-filter">
    <div class="mfilter-hd">
      <strong>Filter</strong>
      <button class="btn btn-ghost" id="mf-close" type="button">Tutup</button>
    </div>
    <div class="mfilter-bd">
      <div class="mfilter-row">
        <div class="fgrp">
          <label for="mf-branch">Branch</label>
          <select id="mf-branch"></select>
        </div>
        <div class="fgrp">
          <label for="mf-area">Area</label>
          <select id="mf-area" title="Pilih Branch dulu" disabled></select>
        </div>
        <div class="fgrp">
          <label for="mf-parent">Group Job</label>
          <select id="mf-parent" title="Pilih Area dulu" disabled></select>
        </div>

        <div class="search" style="width:100%">
          <div class="sico" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 4a6 6 0 1 0 0 12 6 6 0 0 0 0-12Zm-8 6a8 8 0 1 1 14.32 4.906l4.387 4.387-1.414 1.414-4.387-4.387A8 8 0 0 1 2 10Z"/>
            </svg>
          </div>
          <input id="mf-q" type="search" placeholder="Cari job..." autocomplete="off" />
          <div class="sug" id="mf-sug" hidden></div>
        </div>

      </div>
    </div>
    <div class="mfilter-ft">
      <button class="btn btn-ghost" id="mf-clear" type="button">Clear</button>
      <button class="btn btn-primary" id="mf-apply" type="button">Apply</button>
    </div>
  </dialog>

  <script>
  (function(){
    'use strict';
    // ====== CONFIG ======
    const DOC_ID = '1ESGkZf2P_0XMnyJgb7wN_L_Xo144nO6GPg30rrBZW58';
    const SHEET  = 'Sheet1';
    const GID    = '0';
    const APPLY_URL = 'apply.html';

    // Endpoints (prioritas CSV by gid)
    const GVIZ_JSON_SHEET = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET)}`;
    const GVIZ_JSON_GID   = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:json&gid=${GID}`;
    const GVIZ_CSV_SHEET  = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET)}`;
    const GVIZ_CSV_GID    = `https://docs.google.com/spreadsheets/d/${DOC_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;
    const EXPORT_CSV_GID  = `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=csv&gid=${GID}`;
    const EXPORT_CSV_SHEET= `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=csv&sheet=${encodeURIComponent(SHEET)}`;
    const MIRROR = u => 'https://r.jina.ai/https/' + u.replace(/^https?:\/\//,'');

    // Kolom: B=Branch, C=Area, D=Nama Job, E=Group Job, F=Kualifikasi, G=Salary, H=Status
    const COL = { BRANCH:1, AREA:2, JOB_NAME:3, JOB_PARENT:4, QUAL:5, SALARY:6, STATUS:7 };
    const CACHE_KEY = 'CAREERSIMGROUP_cache_v13';

    // ====== Elemen ======
    const $grid = document.getElementById('grid');
    const $status = document.getElementById('status');
    const $pager = document.getElementById('pager');
    const $pgPrev = document.getElementById('pg-prev');
    const $pgNext = document.getElementById('pg-next');
    const $pgInfo = document.getElementById('pg-info');

    const $branch = document.getElementById('f-branch');
    const $area   = document.getElementById('f-area');
    const $parent = document.getElementById('f-parent');
    const $btnApply = document.getElementById('btn-apply');
    const $btnClear = document.getElementById('btn-clear');

    const $dlg = document.getElementById('dlg');
    const $dJob = document.getElementById('dlg-job');
    const $dArea = document.getElementById('dlg-area');
    const $dParent = document.getElementById('dlg-parent');
    const $dQual = document.getElementById('dlg-qual');
    const $dSalary = document.getElementById('dlg-salary');
    const $dlgX = document.getElementById('dlg-x');
    const $dlgClose = document.getElementById('dlg-close');
    const $dlgApply = document.getElementById('dlg-apply');

    const $openFilter = document.getElementById('btn-open-filter');
    const $dlgFilter = document.getElementById('dlg-filter');
    const $mfBranch = document.getElementById('mf-branch');
    const $mfArea = document.getElementById('mf-area');
    const $mfParent = document.getElementById('mf-parent');
    const $mfApply = document.getElementById('mf-apply');
    const $mfClear = document.getElementById('mf-clear');
    const $mfClose = document.getElementById('mf-close');

    const $q = document.getElementById('q');
    const $sug = document.getElementById('sug');
    const $mfQ = document.getElementById('mf-q');
    const $mfSug = document.getElementById('mf-sug');

    let rows = [];
    let page = 1;
    let pageSize = 12;
    let filtered = [];
    let qText = '';

    // ====== Util ======
    const collator = new Intl.Collator('id');
    const esc = s => String(s == null ? '' : s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const norm = s => String(s == null ? '' : s).trim();
    const toKey = s => norm(s).toLowerCase();
    const uniqNorm = (arr) => { const map = new Map(); for(const v of arr){ const k = toKey(v); if(k && !map.has(k)) map.set(k, v); } return [...map.values()].sort((a,b)=>collator.compare(a,b)); };

    function setOptions(el, list, placeholder){
      el.innerHTML = `<option value="">${placeholder}</option>` + list.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');
    }

    function looksLikeHeader(r0){
      const base = (r0||[]).map(x=>String(x||'').toLowerCase());
      const keys = ['branch','area','nama job','job parent','group job','kualifikasi','salary','gaji','status'];
      return keys.some(k => base.includes(k));
    }
    function stripHeader(arr){ if(!arr || !arr.length) return arr || []; return looksLikeHeader(arr[0]) ? arr.slice(1) : arr; }

    function parseCSV(text){
      const out=[]; let row=[]; let cur=''; let inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(c==='"'){ if(inQ && text[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; }
        else if(c===',' && !inQ){ row.push(cur); cur=''; }
        else if((c==='\n' || c==='\r') && !inQ){ if(c==='\r' && text[i+1]==='\n') i++; row.push(cur); out.push(row); row=[]; cur=''; }
        else { cur+=c; }
      }
      if(cur.length>0 || row.length){ row.push(cur); out.push(row); }
      const cleaned = out.filter(r=> r && r.some(cell => String(cell||'').trim().length));
      return stripHeader(cleaned);
    }
    function parseGVizJSON(txt){
      try{
        const json = JSON.parse(txt.slice(txt.indexOf('(')+1, txt.lastIndexOf(')')));
        const rs = (json.table && json.table.rows) ? json.table.rows : [];
        const arr = rs.map(r => (r.c||[]).map(c => c ? (c.f ?? c.v ?? '') : ''));
        return arr.filter(r=> r && r.some(cell => String(cell||'').trim().length));
      } catch{ return []; }
    }
    async function fetchWithTimeout(url, ms=15000){
      const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), ms);
      try{
        const r = await fetch(url, {mode:'cors', cache:'no-cache', signal: ctrl.signal});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.text();
      } finally { clearTimeout(id); }
    }
    async function getData(){
      const order = [
        EXPORT_CSV_GID,
        GVIZ_CSV_GID,
        GVIZ_JSON_GID,
        EXPORT_CSV_SHEET,
        GVIZ_CSV_SHEET,
        GVIZ_JSON_SHEET,
        MIRROR(EXPORT_CSV_GID),
        MIRROR(GVIZ_CSV_GID),
        MIRROR(GVIZ_JSON_GID),
        MIRROR(EXPORT_CSV_SHEET),
        MIRROR(GVIZ_CSV_SHEET),
        MIRROR(GVIZ_JSON_SHEET)
      ];
      let best = null, lastErr = '';
      for(const url of order){
        try{
          const text = await fetchWithTimeout(url);
          const arr = url.includes('out:json') ? parseGVizJSON(text) : parseCSV(text);
          if(arr && arr.length){
            if(!best || arr.length > best.rows.length){ best = {rows: arr, source: url}; }
            if(arr.length >= 20) break;
          }
        }catch(e){ lastErr = e.message; }
      }
      if(best) return best;
      throw new Error('Semua sumber gagal ('+ lastErr +'). Pastikan Tab target dapat diakses publik (Viewer).');
    }

    // ====== Dependent options: Branch → Area → Group
    function updateAreaOptions(){
      const bKey = toKey($branch.value);
      const areas = uniqNorm(
        rows
          .filter(r => !bKey || toKey(r[COL.BRANCH]) === bKey)
          .map(r => r[COL.AREA] || '')
      );
      setOptions($area, areas, bKey ? 'Semua Area' : 'Pilih Branch dulu');
      $area.disabled = !bKey || areas.length === 0;

      $parent.value = '';
      updateParentOptions();
    }

    function updateParentOptions(){
      const bKey = toKey($branch.value);
      const aKey = toKey($area.value);
      const parents = uniqNorm(
        rows
          .filter(r => (!bKey || toKey(r[COL.BRANCH]) === bKey) && (!aKey || toKey(r[COL.AREA]) === aKey))
          .map(r => r[COL.JOB_PARENT] || '')
      );
      setOptions($parent, parents, (bKey && aKey) ? 'Semua Group Job' : 'Pilih Area dulu');
      $parent.disabled = !(bKey && aKey) || parents.length === 0;
    }

    function updateMobileAreaOptions(){
      const bKey = toKey($mfBranch.value || $branch.value);
      const areas = uniqNorm(
        rows
          .filter(r => !bKey || toKey(r[COL.BRANCH]) === bKey)
          .map(r => r[COL.AREA] || '')
      );
      setOptions($mfArea, areas, bKey ? 'Semua Area' : 'Pilih Branch dulu');
      $mfArea.disabled = !bKey || areas.length === 0;

      $mfParent.value = '';
      updateMobileParentOptions();
    }

    function updateMobileParentOptions(){
      const bKey = toKey($mfBranch.value || $branch.value);
      const aKey = toKey($mfArea.value || $area.value);
      const parents = uniqNorm(
        rows
          .filter(r => (!bKey || toKey(r[COL.BRANCH]) === bKey) && (!aKey || toKey(r[COL.AREA]) === aKey))
          .map(r => r[COL.JOB_PARENT] || '')
      );
      setOptions($mfParent, parents, (bKey && aKey) ? 'Semua Group Job' : 'Pilih Area dulu');
      $mfParent.disabled = !(bKey && aKey) || parents.length === 0;
    }

    function fillFilters(){
      const branches = uniqNorm(rows.map(r => r[COL.BRANCH]||''));
      setOptions($branch, branches, 'Semua Branch');
      updateAreaOptions();

      setOptions($mfBranch, branches, 'Semua Branch');
      updateMobileAreaOptions();
    }

    // ====== Icons & card helpers
    const I = {
      briefcase:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2h3a2 2 0 0 1 2 2v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8a2 2 0 0 1 2-2h3V4Zm2 0v2h2V4h-2Z"/></svg>',
      tag:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 12V5h7l7 7-7 7-7-7Zm12-5a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/></svg>',
      fire:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M13.5 2.1s1.7 3.3-.8 5.8c0 0-.3-2.2-2.3-3.6 0 0 .7 2.4-1.2 4.1C7.1 9 6 10.9 6 13a6 6 0 0 0 12 0c0-2.3-1.2-3.9-2.6-5.3-.9-.9-1.6-1.7-1.9-2.8Z"/></svg>',
      dot:'<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><circle cx="12" cy="12" r="6"/></svg>',
      location:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/></svg>',
      money:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h18a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1Zm3 2v6m12-6v6"/><circle cx="12" cy="12" r="2.5"/></svg>'
    };

    function iconFor(parentName){
      const k=(parentName||'').toLowerCase();
      let svg=I.briefcase;
      if(k.includes('sales')) svg=I.tag;
      return `<span class="i" aria-hidden="true">${svg}</span>`;
    }

    function statusCapsule(status){
      const s = toKey(status||'');
      if(!s) return '';
      if(s.includes('urgent')){
        return `<div class="cap-status urgent" aria-label="Urgent hiring"><span class="ico">${I.fire}</span><span class="lbl">URGENT</span></div>`;
      }
      if(s.includes('always')){
        return `<div class="cap-status hiring" aria-label="Selalu membuka lowongan"><span class="ico">${I.dot}</span><span class="lbl">ALWAYS HIRING</span></div>`;
      }
      return '';
    }

    function templateCard(r, idx){
      const job   = esc(r[COL.JOB_NAME]||'');
      const par   = esc(r[COL.JOB_PARENT]||'');
      const area  = esc(r[COL.AREA]||'-');
      const sal   = esc(r[COL.SALARY]||'');
      const stat  = esc(r[COL.STATUS]||'');
      const icon  = iconFor(par);
      return `
        <article class="card" data-i="${idx}" tabindex="0" role="button" aria-label="Lihat detail ${job || '-'}">
          ${statusCapsule(stat)}
          <div class="job-title">${icon}<span>${job || '-'}</span></div>
          <div class="job-parent">${icon}<span>${par || '-'}</span></div>
          <div class="loc">${I.location}<span>${area}</span></div>
          <div class="sal">${I.money}<span>${sal || '-'}</span></div>
          <div class="card-ft">
            <button class="pill" type="button" aria-label="Lihat detail ${job}">Detail</button>
          </div>
        </article>`;
    }

    // ====== Filtering
    function matchSearch(r, q){
      if(!q) return true;
      const hay = `${r[COL.JOB_NAME]||''} ${r[COL.JOB_PARENT]||''} ${r[COL.AREA]||''}`.toLowerCase();
      return hay.includes(q);
    }

    function applyFilter(){
      const bKey = toKey($branch.value);
      const aKey = toKey($area.value);
      const pKey = toKey($parent.value);
      const q = (qText||'').trim().toLowerCase();

      filtered = rows.filter(r => {
        const rBranch = toKey(r[COL.BRANCH]);
        const rArea   = toKey(r[COL.AREA]);
        const rParent = toKey(r[COL.JOB_PARENT]);
        const okB = bKey ? rBranch === bKey : true;
        const okA = aKey ? rArea === aKey : true;
        const okP = pKey ? rParent === pKey : true;
        return okB && okA && okP && matchSearch(r, q);
      });

      page = 1;
      renderPage();
    }

    function renderPage(){
      if(!filtered.length){
        $grid.hidden = true;
        $pager.hidden = true;
        $status.hidden = false;
        $status.textContent = 'Tidak ada data yang cocok dengan filter.';
        $status.setAttribute('aria-busy','false');
        return;
      }
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.min(Math.max(1, page), totalPages);

      const start = (page-1)*pageSize;
      const end   = Math.min(start + pageSize, total);

      $status.hidden = true;
      $grid.hidden = false;
      $grid.innerHTML = '';

      const slice = filtered.slice(start, end);
      let html='';
      for(let i=0;i<slice.length;i++){ html += templateCard(slice[i], start + i); }
      $grid.insertAdjacentHTML('beforeend', html);

      $pager.hidden = false;
      $pgInfo.textContent = `Halaman ${page} dari ${totalPages} • ${total} job`;
      $pgPrev.disabled = page<=1; $pgNext.disabled = page>=totalPages;
      adjustMinHeight();
    }

    function adjustMinHeight(){
      const headH = document.querySelector('header').getBoundingClientRect().height;
      let filterH = 0; const f = document.querySelector('.filters'); if(f && getComputedStyle(f).display!=='none') filterH = f.getBoundingClientRect().height + 12;
      const vh = window.innerHeight; const minH = Math.max(160, vh - headH - filterH - 32);
      $grid.style.minHeight = minH + 'px';
      $status.style.minHeight = minH + 'px';
    }

    function qualToHTML(s){
      const raw = String(s||'').trim();
      if(!raw) return '-';
      let parts = raw.split(/\r?\n/).map(t=>t.trim()).filter(Boolean);
      if(parts.length <= 1){ parts = raw.split(/[•\u2022;]+/).map(t=>t.trim()).filter(Boolean); }
      if(parts.length <= 1 && /(^|\s)-\s+/.test(raw)){ parts = raw.split(/\s*-\s+/).map(t=>t.trim()).filter(Boolean); }
      parts = parts.map(t=>t.replace(/^[-•\u2022]\s*/, '').trim()).filter(Boolean);
      if(!parts.length) return esc(raw);
      return '<ul>' + parts.map(li => `<li>${esc(li)}</li>`).join('') + '</ul>';
    }

    function openModalByIndex(absIndex){
      const r = filtered[absIndex] || [];
      const job = r[COL.JOB_NAME], parent = r[COL.JOB_PARENT], area = r[COL.AREA], qual = r[COL.QUAL], sal = r[COL.SALARY];

      $dJob.textContent = job || '-';
      $dParent.textContent = parent ? `Group Job: ${parent}` : '-';
      $dArea.textContent = area || '-';
      $dSalary.textContent = sal || '-';
      $dQual.innerHTML = qualToHTML(qual || '');

      const params = new URLSearchParams({ job: job || '', area: area || '' });
      $dlgApply.href = `${APPLY_URL}?${params.toString()}`;

      if(typeof $dlg.showModal === 'function') $dlg.showModal(); else $dlg.setAttribute('open','');
    }
    function closeModal(){ if($dlg.open) $dlg.close(); else $dlg.removeAttribute('open'); }

    // ====== Suggest (>=3 huruf) ======
    const MIN_SUG = 3;
    const MAX_SUG = 10;

    function buildSuggestions(q){
      const qq = (q||'').trim().toLowerCase();
      if(qq.length < MIN_SUG) return [];
      const out = [];
      const seen = new Set();

      for(const r of rows){
        const job = norm(r[COL.JOB_NAME]);
        if(!job) continue;
        if(!job.toLowerCase().includes(qq)) continue;

        const parent = norm(r[COL.JOB_PARENT]);
        const area = norm(r[COL.AREA]);
        const key = (job.toLowerCase() + '|' + parent.toLowerCase() + '|' + area.toLowerCase());
        if(seen.has(key)) continue;
        seen.add(key);

        out.push({ job, parent, area });
        if(out.length >= MAX_SUG) break;
      }
      return out;
    }

    function renderSug(container, items){
      if(!items.length){
        container.hidden = true;
        container.innerHTML = '';
        return;
      }
      container.hidden = false;
      container.innerHTML =
        `<div class="sug-hd">Suggestions</div>` +
        items.map(it => `
          <div class="sug-item" data-job="${esc(it.job)}">
            <div class="sug-ico" aria-hidden="true">${I.briefcase}</div>
            <div>
              <p class="sug-title">${esc(it.job)}</p>
              <p class="sug-meta">${esc(it.parent || '-')} • ${esc(it.area || '-')}</p>
            </div>
          </div>
        `).join('');
    }

    function hideSug(container){
      container.hidden = true;
      container.innerHTML = '';
    }

    function attachSugBehavior(inputEl, sugEl, onPick){
      let t = null;

      inputEl.addEventListener('input', ()=>{
        clearTimeout(t);
        t = setTimeout(()=>{
          const v = inputEl.value || '';
          const items = buildSuggestions(v);
          renderSug(sugEl, items);
        }, 90);
      });

      sugEl.addEventListener('click', (e)=>{
        const item = e.target.closest('.sug-item');
        if(!item) return;
        const job = item.getAttribute('data-job') || '';
        if(job){
          onPick(job);
          hideSug(sugEl);
        }
      });

      document.addEventListener('click', (e)=>{
        const inside = (e.target === inputEl) || sugEl.contains(e.target);
        if(!inside) hideSug(sugEl);
      });

      inputEl.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){ hideSug(sugEl); }
      });

      inputEl.addEventListener('blur', ()=>{
        setTimeout(()=> hideSug(sugEl), 160);
      });
    }

    // ====== Events ======
    document.addEventListener('click', e => {
      if(e.target.closest('.pill')){
        const card = e.target.closest('.card');
        if(card){ openModalByIndex(Number(card.dataset.i)); return; }
      }
      const card = e.target.closest('.card');
      if(card && $grid.contains(card)){ openModalByIndex(Number(card.dataset.i)); }
    });
    document.addEventListener('keydown', e => {
      const card = e.target.closest('.card');
      if(card && (e.key === 'Enter' || e.key === ' ')){ e.preventDefault(); openModalByIndex(Number(card.dataset.i)); }
    });

    $dlgX.addEventListener('click', closeModal);
    $dlgClose.addEventListener('click', closeModal);

    // Filter desktop
    $btnApply.addEventListener('click', applyFilter);
    $btnClear.addEventListener('click', ()=>{
      $branch.value=''; $area.value=''; $parent.value='';
      qText=''; $q.value='';
      hideSug($sug);
      updateAreaOptions();
      applyFilter();
    });
    $branch.addEventListener('change', ()=>{ updateAreaOptions(); applyFilter(); });
    $area.addEventListener('change', ()=>{ updateParentOptions(); applyFilter(); });
    $parent.addEventListener('change', applyFilter);

    // Search live (tidak bold)
    let tQ = null;
    $q.addEventListener('input', ()=>{
      clearTimeout(tQ);
      tQ = setTimeout(()=>{
        qText = $q.value || '';
        applyFilter();
      }, 120);
    });

    // Pager
    $pgPrev.addEventListener('click', ()=>{ page--; renderPage(); window.scrollTo({top:0,behavior:'smooth'}); });
    $pgNext.addEventListener('click', ()=>{ page++; renderPage(); window.scrollTo({top:0,behavior:'smooth'}); });

    // Filter Mobile
    $openFilter.addEventListener('click', ()=>{
      $mfBranch.value = $branch.value || '';
      updateMobileAreaOptions();
      $mfArea.value = $area.value || '';
      updateMobileParentOptions();
      $mfParent.value = $parent.value || '';

      $mfQ.value = $q.value || '';
      hideSug($mfSug);

      if(typeof $dlgFilter.showModal === 'function') $dlgFilter.showModal(); else $dlgFilter.setAttribute('open','');
    });

    $mfBranch.addEventListener('change', ()=>{ updateMobileAreaOptions(); $mfParent.value=''; });
    $mfArea.addEventListener('change', ()=>{ updateMobileParentOptions(); });

    $mfApply.addEventListener('click', ()=>{
      $branch.value = $mfBranch.value;
      $area.value   = $mfArea.value;
      updateAreaOptions();
      $parent.value = $mfParent.value;

      $q.value = $mfQ.value || '';
      qText = $q.value || '';
      applyFilter();

      if($dlgFilter.open) $dlgFilter.close();
    });

    $mfClear.addEventListener('click', ()=>{
      $mfBranch.value=''; $mfArea.value=''; $mfParent.value=''; $mfQ.value='';
      updateMobileAreaOptions(); updateMobileParentOptions();
      hideSug($mfSug);
    });

    $mfClose.addEventListener('click', ()=>{ if($dlgFilter.open) $dlgFilter.close(); });

    // ====== Init ======
    (async function init(){
      const head = document.querySelector('header');
      const updateSticky = ()=> document.documentElement.style.setProperty('--sticky-top', head.getBoundingClientRect().height + 'px');
      updateSticky();
      window.addEventListener('resize', ()=>{ updateSticky(); renderPage(); adjustMinHeight(); });

      // Attach suggest
      attachSugBehavior($q, $sug, (job)=>{
        $q.value = job;
        qText = job;
        applyFilter();
      });
      attachSugBehavior($mfQ, $mfSug, (job)=>{
        $mfQ.value = job;
      });

      try{
        const cache = localStorage.getItem(CACHE_KEY);
        if(cache){
          const cached = JSON.parse(cache);
          if(Array.isArray(cached.rows) && cached.rows.length){
            rows = cached.rows;
            fillFilters(); applyFilter();
          }
        }

        const res = await getData();
        rows = stripHeader(res.rows || res) || [];
        rows = rows.filter(r => r && (String(r[COL.JOB_NAME]||'').trim() || String(r[COL.JOB_PARENT]||'').trim() || String(r[COL.AREA]||'').trim() || String(r[COL.BRANCH]||'').trim()));
        localStorage.setItem(CACHE_KEY, JSON.stringify({rows}));

        fillFilters(); applyFilter();
        $status.hidden = true; $grid.hidden = false; $status.setAttribute('aria-busy','false');
      }catch(err){
        console.error('[CAREER SIMGROUP] load fail', err);
        if(!rows.length){
          $status.textContent = 'Gagal memuat data: ' + err.message;
          $status.setAttribute('aria-busy','false');
        }
      }
      adjustMinHeight();
    })();

  })();
  </script>
</body>
</html>
